# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions
# More info on Python, GitHub Actions, and Azure App Service: https://aka.ms/python-webapps-actions

name: Build and deploy Python app to Azure Web App - clinic-ai-backend

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python version
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # üõ†Ô∏è Local Build Section (Optional)
      # The following section in your workflow is designed to catch build issues early on the client side, before deployment. This can be helpful for debugging and validation. However, if this step significantly increases deployment time and early detection is not critical for your workflow, you may remove this section to streamline the deployment process.
      - name: Create and Start virtual environment and Install dependencies
        run: |
          python -m venv antenv
          source antenv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          # Verify critical packages are installed
          echo "‚úÖ Verifying dependencies..."
          pip list | grep -E "(uvicorn|fastapi|pydantic)" || echo "‚ö†Ô∏è  Warning: Some packages not found"
          echo "‚úÖ Virtual environment created successfully"
                
      # IMPORTANT: Include antenv/ in deployment
      # This ensures dependencies are available on Azure App Service
      # Oryx should build, but if it doesn't, this ensures the app works
      - name: Upload artifact for deployment jobs
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: |
            .
            !.git/
            !__pycache__/
            !*.pyc
            !.pytest_cache/
            !.mypy_cache/
          retention-days: 1

      # üö´ Opting Out of Oryx Build
      # If you prefer to disable the Oryx build process during deployment, follow these steps:
      # 1. Remove the SCM_DO_BUILD_DURING_DEPLOYMENT app setting from your Azure App Service Environment variables.
      # 2. Refer to sample workflows for alternative deployment strategies: https://github.com/Azure/actions-workflow-samples/tree/master/AppService
      

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write #This is required for requesting the JWT
      contents: read #This is required for actions/checkout

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: python-app
      
      - name: Verify deployment structure
        run: |
          echo "üì¶ Verifying deployment structure..."
          ls -la
          echo ""
          echo "Checking critical files..."
          test -f requirements.txt && echo "‚úÖ requirements.txt exists" || echo "‚ùå requirements.txt missing"
          test -f startup.py && echo "‚úÖ startup.py exists" || echo "‚ùå startup.py missing"
          test -d src && echo "‚úÖ src directory exists" || echo "‚ùå src directory missing"
          echo ""
          echo "Checking virtual environment..."
          if [ -d "antenv" ]; then
            echo "‚úÖ antenv exists"
            echo "Virtual environment size:"
            du -sh antenv
            echo "Checking for uvicorn..."
            if [ -f "antenv/bin/uvicorn" ]; then
              echo "‚úÖ uvicorn found in virtual environment"
            else
              echo "‚ö†Ô∏è  uvicorn not found - check build logs"
            fi
          else
            echo "‚ùå antenv missing - deployment will fail!"
            exit 1
          fi
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_8C7D6B9D76604AA8AE7851F0828194C2 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_0F4BE5C05D7142339421EE43640F5864 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_7F1E38EE614E473FB033124105FB8D5B }}

      - name: Wait for any ongoing deployments
        run: |
          echo "‚è≥ Waiting 20 seconds for any ongoing deployments to complete..."
          sleep 20

      - name: 'Deploy to Azure Web App'
        uses: azure/webapps-deploy@v3
        id: deploy-to-webapp
        with:
          app-name: 'clinic-ai-backend-b4anbydmd2gfa4fd'
          slot-name: 'Production'
          # Use zip deployment for better reliability with large files
          type: zip
          # Increase timeout for large deployments (antenv can be large)
          start-timeout: 600
          