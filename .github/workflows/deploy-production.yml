# Production Deployment Workflow
# This workflow deploys to the Production environment.
# ALWAYS workflow_dispatch only with manual confirmation required.

name: ðŸš€ Deploy to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        type: string

env:
  ACR_LOGIN_SERVER: clinicaiacr.azurecr.io
  IMAGE_NAME: clinicai-backend
  RESOURCE_GROUP: clinic-ai

jobs:
  validate-confirmation:
    name: âœ… Validate Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check deployment confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "DEPLOY" ]; then
            echo "âŒ Production deployment not confirmed."
            echo "   You must type 'DEPLOY' in the confirm input."
            exit 1
          fi
          echo "âœ… Production deployment confirmed"

  build-and-deploy:
    name: ðŸš€ Build & Deploy to Production
    runs-on: ubuntu-latest
    needs: validate-confirmation
    environment: production
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“‹ Read environment config
        id: config
        uses: ./.github/actions/read-config
        with:
          environment: 'production'

      - name: ðŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: ðŸ³ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ steps.config.outputs.docker_context }}
          file: ${{ steps.config.outputs.dockerfile }}
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:production-latest
          cache-from: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: ðŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PRODUCTION }}

      - name: ðŸš€ Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ steps.config.outputs.app_name }}
          slot-name: ${{ steps.config.outputs.slot_name }}
          images: ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: â³ Wait for deployment
        run: sleep 90

      - name: ðŸ¥ Health Check
        run: |
          echo "ðŸ§ª Testing production health endpoint..."
          HEALTH_URL="${{ steps.config.outputs.health_url }}"
          echo "Testing: $HEALTH_URL"
          
          for i in {1..15}; do
            if curl -f -k "$HEALTH_URL"; then
              echo "âœ… Production health check passed!"
              exit 0
            fi
            echo "â³ Attempt $i/15 failed, retrying in 15s..."
            sleep 15
          done
          
          echo "âŒ Production health check failed after 15 attempts"
          exit 1

      - name: ðŸ“Š Deployment Summary
        if: always()
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Production ðŸ”´" >> $GITHUB_STEP_SUMMARY
          echo "- **App Service:** ${{ steps.config.outputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health URL:** ${{ steps.config.outputs.health_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
